(()=>{"use strict";var t={m:{},u:t=>"static/js/"+t+".aea85cc4.chunk.js",o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),p:"/POLYTECH-IA-PROJET-PIPOPIPETTE/"};t.b=self.location+"/../../../";class e{constructor(t){this.cells=[],this.verticals=[],this.horizontals=[],this.previousBoard=null,this.score=[0,0],this.tour=0,"number"===typeof t?(this.cells=new Array(t).fill(0).map((()=>new Array(t).fill(-1))),this.verticals=new Array(t).fill(0).map((()=>new Array(t+1).fill(-1))),this.horizontals=new Array(t+1).fill(0).map((()=>new Array(t).fill(-1))),this.score=[0,0],this.tour=0):(this.cells=t.cells,this.verticals=t.verticals,this.horizontals=t.horizontals,this.score=t.score,this.tour=t.tour,this.previousBoard=t.previousBoard||null)}getWinner(){return this.score[0]>this.score[1]?0:this.score[0]<this.score[1]?1:-1}play(t,i,s){const o=this.horizontals.map((t=>[...t])),n=this.verticals.map((t=>[...t])),a=this.cells.map((t=>[...t])),r=[...this.score];let l=this.tour;if("vertical"===t){if(-1!==n[s][i])return console.error("Invalid move "+t+i+s),null;n[s][i]=this.tour}else{if(-1!==o[s][i])return console.error("Invalid move "+t+i+s),null;o[s][i]=this.tour}const h=[];if("horizontal"===t){let t=this.check(o,n,i,s);t&&h.push(t),t=this.check(o,n,i,s-1),t&&h.push(t)}else{let t=this.check(o,n,i,s);t&&h.push(t),t=this.check(o,n,i-1,s),t&&h.push(t)}return h.length?(r[l]+=h.length,h.forEach((t=>{a[t[1]][t[0]]=l}))):l=1===l?0:1,new e({cells:a,verticals:n,horizontals:o,score:r,tour:l,previousBoard:this})}isFinished(){return this.score[0]>this.cells.length**2/2||this.score[1]>this.cells.length**2/2||this.score[0]+this.score[1]===this.cells.length**2}check(t,e,i,s){var o;return!(i<0||i>=this.cells.length||s<0||s>=this.cells.length)&&(-1!==e[s][i]&&-1!==e[s][i+1]&&-1!==t[s][i]&&-1!==(null===(o=t[s+1])||void 0===o?void 0:o[i])&&[i,s])}evaluation(t){return this.score[t]-this.score[1===t?0:1]}*getNodes(t){const e=[...this.verticals.flatMap(((t,e)=>t.map(((t,i)=>({x:i,y:e,value:t,orientation:"vertical"}))))).filter((t=>{let{value:e}=t;return-1===e})),...this.horizontals.flatMap(((t,e)=>t.map(((t,i)=>({x:i,y:e,value:t,orientation:"horizontal"}))))).filter((t=>{let{value:e}=t;return-1===e}))];let i=e.length;for(;0!==i;){let t=Math.floor(Math.random()*i);i--,[e[i],e[t]]=[e[t],e[i]]}for(let s=0;s<e.length;s++){const{x:i,y:o,orientation:n}=e[s],a=this.play(n,i,o);if(a.tour===a.previousBoard.tour&&!a.isFinished()&&(void 0===t||t>0))for(const e of a.getNodes(t?t-1:void 0))yield{...e,x:i,y:o,orientation:n};else yield{x:i,y:o,board:a,orientation:n}}}}class i extends EventTarget{constructor(t,i,s){super(),this.board=void 0,this.players=void 0,this.playing=!1,this.board=new e(t),this.players=[i,s],this.play()}getBoard(){return this.board}async play(){if(this.playing)return;for(this.playing=!0;!this.board.isFinished();)await this.players[this.board.tour].play(this.board,this.board.tour).then((t=>{const e=this.board.play(t.orientation,t.x,t.y);e&&(this.board=e,this.dispatchEvent(new CustomEvent("played",{detail:{played:{x:t.x,y:t.y,orientation:t.orientation,player:e.previousBoard.tour},board:this.board}})))}));const[t,e]=this.board.score;this.dispatchEvent(new CustomEvent("end",{detail:{winner:t>e?0:t<e?1:-1}}))}async start(){await this.play()}}class s extends EventTarget{constructor(){super(...arguments),this.totalTime=0,this.totalMove=0,this.times=[]}}class o extends s{constructor(t){let{minTimeToPlay:e}=t;super(),this.minTimeToPlay=0,this.minTimeToPlay=e||500}async play(t,e){return(await Promise.all([new Promise((async i=>{const s=performance.now(),o=await this.playIa(t,e),n=performance.now();this.totalTime+=n-s,this.totalMove++,this.times.push(n-s),console.log(`Player ${e} (${this.constructor.name}) Time: ${n-s}ms Average time: ${this.totalTime/this.totalMove}ms`),i(o)})),new Promise((t=>setTimeout(t,this.minTimeToPlay)))]))[0]}}class n extends o{constructor(t){super(t),this.depth=void 0,this.depthLimit=void 0,this.depth=t.depth,this.depthLimit=t.depthLimit}playIa(t,e){return new Promise((i=>{const{nodes:s,...o}=function(t,e,i,s){let o={x:0,y:0,orientation:"horizontal"},n=0;const a=new Map;function r(t){return`${t.horizontals.map((t=>t.map((t=>-1!==t?1:0)).join(""))).join("")}${t.verticals.map((t=>t.map((t=>-1!==t?1:0)).join(""))).join("")}${t.score.join("")}${t.tour}`}const l=function t(l,h,c){let d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1/0,u=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1/0;if(0===h||l.isFinished())return l.evaluation(i)*(c?1:-1);let p=-1/0;for(const{board:i,...m}of l.getNodes(s)){n++;const s=r(i);if(a.has(s))p=Math.max(p,a.get(r(i)));else{const n=t(i,h-1,!c,-u,-d);a.set(s,-n),-n>p&&(h===e&&(o=m),p=-n)}if(p>=u)return p;d=Math.max(d,p)}return p}(t,e,!0);return{value:l,...o,nodes:n}}(t,this.depth,e,this.depthLimit);console.log(`Player ${e} (${this.constructor.name}) : ${s} nodes`),i(o)}))}}class a extends o{constructor(t){super(t),this.parameters=void 0,this.ias=["minimax","alphabeta","mcts"],this.parameters=t}async playIa(e,i){const s=[],[o,n]=await Promise.race(this.ias.map((o=>new Promise((n=>{const a=new Worker(new URL(t.p+t.u(843),t.b));s.push(a),a.postMessage({board:JSON.parse(JSON.stringify(e)),parameters:this.parameters,player:i,type:o}),a.addEventListener("message",(t=>{n([t.data,o])}))})))));return s.forEach((t=>t.terminate())),console.log(`Player ${i} (${n})`),o}}class r extends s{play(t,e){return new Promise((t=>{const i=performance.now();this.addEventListener("play",(s=>{const o=performance.now();this.totalTime+=o-i,this.totalMove++,this.times.push(o-i),console.log(`Player ${e} (${this.constructor.name}) Time: ${o-i} Average time: ${this.totalTime/this.totalMove}ms`);t(s.detail)}),{once:!0})}))}}class l{constructor(t,e,i,s){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;this.wins=void 0,this.visits=void 0,this.nodes=void 0,this.parent=void 0,this.board=void 0,this.player=void 0,this.simulation=void 0,this.c=void 0,this.generator=void 0,this.wins=0,this.visits=0,this.nodes=new Map,this.parent=o,this.generator=t.getNodes(),this.board=t,this.simulation=i,this.player=e,this.c=s}run(){if(this.board.isFinished()){for(let t=0;t<this.simulation;t++)this.backpropagation(this.simulate());return}let t=this.expansion();if(t)for(let e=0;e<this.simulation;e++)t.backpropagation(t.simulate());else{const{bestNode:t}=this.selection();t.run()}}selection(){let t=null,e=0,i=0,s="vertical",o=-1/0;return this.nodes.forEach(((n,a)=>{n.forEach(((n,r)=>{n.forEach(((n,l)=>{const h=n.wins/n.visits+this.c*Math.sqrt(2*Math.log(this.visits)/n.visits);h>o&&(o=h,s=a,e=+r,i=+l,t=n)}))}))})),{bestNode:t,x:e,y:i,orientation:s}}simulate(){let t=this.board;for(;;){const{value:e,done:i}=t.getNodes().next();if(i)break;t=e.board}return t.getWinner()===this.player}expansion(){const{value:t,done:e}=this.generator.next();if(e)return!1;const{orientation:i,x:s,y:o,board:n}=t,a=new l(n,this.player,this.simulation,this.c,this);let r=this.nodes.get(i);r||(r=new Map,this.nodes.set(i,r));let h=r.get(s);return h||(h=new Map,r.set(s,h)),h.set(o,a),a}backpropagation(t){t&&this.wins++,this.visits++,this.parent&&this.parent.backpropagation(t)}getBestChild(){let t=null,e=0,i=0,s="vertical",o=-1/0;return this.nodes.forEach(((n,a)=>{n.forEach(((n,r)=>{n.forEach(((n,l)=>{const h=n.wins/n.visits;h>o&&(s=a,e=+r,i=+l,o=h,t=n)}))}))})),{bestNode:t,x:e,y:i,orientation:s}}getNumberVisited(){return this.visits}}class h extends o{constructor(t){super(t),this.iteration=void 0,this.simulation=void 0,this.c=void 0,this.lastBoard=null,this.lastNode=null,this.iteration=t.iteration,this.simulation=t.simulation,this.c=t.c||Math.sqrt(2)}playIa(t,e){return new Promise((i=>{let s=null;if(this.lastBoard&&this.lastNode){const e=this.lastBoard.horizontals.flatMap(((e,i)=>e.map(((e,s)=>-1===e&&-1!==t.horizontals[i][s]?{x:s,y:i,orientation:"horizontal"}:null)))).filter((t=>t)).concat(this.lastBoard.verticals.flatMap(((e,i)=>e.map(((e,s)=>-1===e&&-1!==t.verticals[i][s]?{x:s,y:i,orientation:"vertical"}:null)))).filter((t=>t)));0===e.length&&(s=this.lastNode);let i=-1/0;if(e.length>0)for(const t of function(t){let e=[];function i(t,s){if(0===t.length)e.push(s.slice());else for(let e=0;e<t.length;e++){let o=t.slice(),n=o.splice(e,1);i(o,s.concat(n))}}return i(t,[]),e}(e)){var o,n;let e=(null===(o=this.lastNode.nodes.get(t[0].orientation))||void 0===o||null===(n=o.get(t[0].x))||void 0===n?void 0:n.get(t[0].y))||null;for(let i=1;i<t.length;i++){var a,r,h;if(e=(null===(a=e)||void 0===a||null===(r=a.nodes.get(t[i].orientation))||void 0===r||null===(h=r.get(t[i].x))||void 0===h?void 0:h.get(t[i].y))||null,!e)break}e&&e.wins>i&&(i=e.wins,s=e)}}let c=s||new l(t,e,this.simulation,this.c);for(;c.getNumberVisited()<this.iteration*this.simulation;)c.run();this.dispatchEvent(new CustomEvent("tree",{detail:c}));let d=c.getBestChild();this.lastNode=d.bestNode,this.lastBoard=t.play(d.orientation,d.x,d.y),i({x:d.x,y:d.y,orientation:d.orientation})}))}}class c extends o{constructor(t){super(t),this.depth=void 0,this.depthLimit=void 0,this.depth=t.depth,this.depthLimit=t.depthLimit}playIa(t,e){return new Promise((i=>{const{nodes:s,...o}=function(t,e,i,s){let o={x:0,y:0,orientation:"horizontal"},n=0;const a=new Map;function r(t){return`${t.horizontals.map((t=>t.map((t=>-1!==t?1:0)).join(""))).join("")}${t.verticals.map((t=>t.map((t=>-1!==t?1:0)).join(""))).join("")}${t.score.join("")}${t.tour}`}const l=function t(l,h,c){if(0===h||l.isFinished())return l.evaluation(i)*(c?1:-1);let d=-1/0;for(const{board:i,...u}of l.getNodes(s)){n++;const s=r(i);if(a.has(s)){d=Math.max(d,a.get(r(i)));continue}const l=t(i,h-1,!c);a.set(s,-l),-l>d&&(h===e&&(o=u),d=-l)}return d}(t,e,!0);return{...o,value:l,nodes:n}}(t,this.depth,e,this.depthLimit);console.log(`Player ${e} (${this.constructor.name}) : ${s} nodes`),i(o)}))}}class d extends o{playIa(t,e){return Promise.resolve(t.getNodes().next().value)}}DedicatedWorkerGlobalScope.prototype.emit=function(){this.postMessage({type:arguments.length<=0?void 0:arguments[0],data:arguments.length<=1?void 0:arguments[1]})},self.addEventListener("message",(t=>{let{data:{data:e,type:i}}=t;self.dispatchEvent(new CustomEvent(i,{detail:e}))}));let u=null;function p(t){switch(t.type){case"human":return new r;case"random":return new d(t);case"minimax":return new c(t);case"alphabeta":return new n(t);case"mcts":return new h(t);case"fastest":return new a(t)}}self.addEventListener("start",(t=>{let{detail:{player1:e,player2:s,size:o}}=t;if(u)return;const n=p(e),a=p(s);u=new i(o,n,a),n instanceof r&&self.addEventListener("play",(t=>{n.dispatchEvent(new CustomEvent("play",{detail:t.detail}))})),a instanceof r&&self.addEventListener("play",(t=>{a.dispatchEvent(new CustomEvent("play",{detail:t.detail}))})),self.emit("change",u.getBoard()),u.addEventListener("end",(t=>{const{winner:e}=t.detail;self.emit("end",{winner:e})})),u.addEventListener("played",(t=>{const{board:e}=t.detail;self.emit("change",e)})),u.start().then((()=>{self.emit("end",{winner:u.getBoard().getWinner()})}))}))})();
//# sourceMappingURL=378.d878fd34.chunk.js.map